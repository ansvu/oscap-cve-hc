#!/bin/bash 

print_help() {
    cat <<EOF
------------------------------------------------------------------------------------------------------------------------
Usage: $0 -i|--image-name  <image-id|image-name> -o|-output-html <output filename> -u|--user-name <linux username> -v|-rhel-ver <rhel9|rhel8>
Usage: $0 [-h | --help]
Usage Ex1: $0 -i 440906d95020 -o ceph6 -u avu -v rhel9
Usage Ex2: $0 -i registry.redhat.io/rhceph/rhceph-6-rhel9:6-334 -o ceph6 -u avu -v rhel9
------------------------------------------------------------------------------------------------------------------------
EOF
    exit 0
}

check_command() {
    command -v "$1" >/dev/null 2>&1 || { echo "$1 is not installed, please install it using dnf install $2 -y"; exit 1; }
}

# Parse Arguments
while getopts ":i:o:u:v:h" opt; do
  case ${opt} in
    i ) IMAGE=$OPTARG ;;
    o ) OUTPUT=$OPTARG ;;
    u ) USERNAME=$OPTARG ;;
    v ) RHELVER=$OPTARG ;;
    h ) print_help ;;
    \? ) echo "Invalid option: $OPTARG" >&2; print_help ;;
  esac
done

# Ensure required arguments are set
if [[ -z "$IMAGE" || -z "$USERNAME" || -z "$RHELVER" ]]; then
    echo "Missing required parameters."
    print_help
fi

# Check if user is root
if [[ $(whoami) != "root" ]]; then
    echo "You must be a root user to run oscap-podman!"
    exit 1
fi

# Check necessary commands
check_command "oscap-podman" "openscap-utils"
check_command "podman" "podman"

# Ensure RHEL version is set, and if not rhel8 or rhel9, default to rhel9
if [[ "$RHELVER" != "rhel8" && "$RHELVER" != "rhel9" ]]; then
    echo "Invalid or unspecified RHEL version. Defaulting to rhel9."
    RHELVER="rhel9"
fi
OUTPUT=${OUTPUT:-"mytest-output"}

# Extract the major version number
RHELVerNum=${RHELVER//[!0-9]/} # in-case it needs to use 9.x instead of 9, hardcoded here

# Download the appropriate OVAL file
echo "Downloading OVAL file for $RHELVER..."
wget -q -O - "https://www.redhat.com/security/data/oval/v2/${RHELVER^^}/rhel-${RHELVerNum}.oval.xml.bz2" | bzip2 -d > "rhel-${RHELVerNum}.oval.xml"
if [ $? -ne 0 ]; then
    echo "Failed to download rhel-${RHELVerNum}.oval.xml file. Please check the version!"
    exit 1
fi

echo "Download successful. Proceeding with the oscap-podman scan..."
echo "Starting CVE SCAN with OSCAP using rhel-${RHELVerNum}.oval.xml, please wait..."
oscap-podman ${IMAGE} oval eval --report /home/${USERNAME}/Downloads/${OUTPUT}.html rhel-${RHELVerNum}.oval.xml
ls -lrt /home/${USERNAME}/Downloads/${OUTPUT}.html
