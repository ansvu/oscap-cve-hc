# oscap-cve-hc
This repo is to help to do  health check of image for CVE using oscap-podman 

# Manual Step to scan image health check for CVE 
Pre-requisite:
- Install oscap-podman 
  sudo dnf -y install openscap-utils 
- Install podman to pull image
  sudo dnf -y install podman 
- Download OVAL definition according the RHEL Major version from your image
```shellSession
  wget -q -O - https://www.redhat.com/security/data/oval/v2/9/rhel-9.oval.xml.bz2 | bzip2 --decompress -f > rhel-9.oval.xml
```
- Must have root access to use oscap-pomand to scan 
- Tested only with RHEL and Fedora 

## Start scan the image:
- From root user
```shellSession
oscap-podman 440906d95020 oval eval --report /home/your-user-name/Downloads/ceph6.html rhel-9.oval.xml
oscap-podman registry.redhat.io/rhceph/rhceph-6-rhel9:6-334 --report /home/ava/Downloads/ceph6.html rhel-9.oval.xml
```
# Using the shellscript run image health check for CVE
Usage: 
```shellShession
bash oscap-podman-hc.sh
------------------------------------------------------------------------------------------------------------------------
Usage: oscape-podman-hc.sh -i|--image-name  <image-id|image-name> -o|-output-html <output filename> -u|--user-name <linux username> -v|-rhel-ver <hrel9|rhel8>
Usage: oscape-podman-hc.sh [-h | --help]
Usage Ex1: oscape-podman-hc.sh -i 440906d95020 -o ceph6 -u ava -v rhel9
Usage Ex2: oscape-podman-hc.sh -i registry.redhat.io/rhceph/rhceph-6-rhel9:6-334 -o ceph6 -u ava -v rhel9
```

oscap-podman-hc.sh:
```bash
# cat oscap-podman-hc.sh
#!/bin/bash 

print_help() {
    cat <<EOF
------------------------------------------------------------------------------------------------------------------------
Usage: $0 -i|--image-name  <image-id|image-name> -o|-output-html <output filename> -u|--user-name <linux username> -v|-rhel-ver <rhel9|rhel8>
Usage: $0 [-h | --help]
Usage Ex1: $0 -i 440906d95020 -o ceph6 -u ava -v rhel9
Usage Ex2: $0 -i registry.redhat.io/rhceph/rhceph-6-rhel9:6-334 -o ceph6 -u ava -v rhel9
------------------------------------------------------------------------------------------------------------------------
EOF
    exit 0
}

check_command() {
    command -v "$1" >/dev/null 2>&1 || { echo "$1 is not installed, please install it using dnf install $2 -y"; exit 1; }
}

# Parse Arguments
while getopts ":i:o:u:v:h" opt; do
  case ${opt} in
    i ) IMAGE=$OPTARG ;;
    o ) OUTPUT=$OPTARG ;;
    u ) USERNAME=$OPTARG ;;
    v ) RHELVER=$OPTARG ;;
    h ) print_help ;;
    \? ) echo "Invalid option: $OPTARG" >&2; print_help ;;
  esac
done

# Ensure required arguments are set
if [[ -z "$IMAGE" || -z "$USERNAME" || -z "$RHELVER" ]]; then
    echo "Missing required parameters."
    print_help
fi

# Check if user is root
if [[ $(whoami) != "root" ]]; then
    echo "You must be a root user to run oscap-podman!"
    exit 1
fi

# Check necessary commands
check_command "oscap-podman" "openscap-utils"
check_command "podman" "podman"

# Ensure RHEL version is set, default to RHEL9
RHELVER=${RHELVER:-"rhel9"}
OUTPUT=${OUTPUT:-"mytest-output"}

# Extract the major version number
RHELVerNum=${RHELVER//[!0-9]/}

# Download the appropriate OVAL file
echo "Downloading OVAL file for $RHELVER..."
wget -q -O - "https://www.redhat.com/security/data/oval/v2/${RHELVER^^}/rhel-${RHELVerNum}.oval.xml.bz2" | bzip2 -d > "rhel-${RHELVerNum}.oval.xml"
if [ $? -ne 0 ]; then
    echo "Failed to download rhel-${RHELVerNum}.oval.xml file. Please check the version!"
    exit 1
fi

echo "Download successful. Proceeding with the oscap-podman scan..."
echo "Starting CVE SCAN with OSCAP using rhel-${RHELVerNum}.oval.xml, please wait..."
oscap-podman ${IMAGE} oval eval --report /home/${USERNAME}/Downloads/${OUTPUT}.html rhel-${RHELVerNum}.oval.xml
ls -lrt /home/${USERNAME}/Downloads/${OUTPUT}.html
```

## Results of HTML output
